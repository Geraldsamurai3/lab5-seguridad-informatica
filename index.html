<!doctype html>
<html>
  <head>
    <title>Chat Socket.IO UNA - Secure</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; padding-top: 50px; }
      
      /* Barra de usuario */
      #userBar { 
        position: fixed; 
        top: 0; 
        left: 0; 
        right: 0; 
        background: #333; 
        color: white; 
        padding: 10px 20px; 
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        z-index: 1000;
      }
      #userInfo { display: flex; align-items: center; gap: 10px; }
      #userAvatar { 
        width: 30px; 
        height: 30px; 
        border-radius: 50%; 
        border: 2px solid #fff;
      }
      #userName { font-weight: bold; }
      #logoutBtn { 
        background: #e74c3c; 
        color: white; 
        border: none; 
        padding: 8px 15px; 
        border-radius: 4px; 
        cursor: pointer;
        text-decoration: none;
        font-size: 12px;
      }
      #logoutBtn:hover { background: #c0392b; }
      
      /* Chat */
      form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      form input { border: 0; padding: 10px;}
      form button { width: 10%; background: rgb(130, 224, 255);  border: none; padding: 10px; }
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
      #messages { margin-bottom: 40px }
      #nombre, #m { display: inline-block;}
      #m {width: 69%; margin-right: 4px;}
      #nombre {width: 20%}
    </style>
  </head>
  <body>
    <!-- Barra de informaci贸n del usuario -->
    <div id="userBar">
      <div id="userInfo">
        <img id="userAvatar" src="" alt="User">
        <div>
          <div id="userName">Cargando...</div>
          <div id="userEmail" style="font-size: 11px; color: #ccc;"></div>
        </div>
      </div>
      <a href="/logout" id="logoutBtn">Cerrar Sesi贸n</a>
    </div>

    <ul id="messages"></ul>
    <form action="">
      <input id="nombre" autocomplete="off" placeholder="Username" readonly/>
      <input id="m" autocomplete="off" placeholder="Escriba un mensaje" /><button>Send</button>
    </form>
    <script src="https://cdn.socket.io/4.7.2/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>

    var colorHexTxt = "";
    var currentUser = null;

    // genera colores aleatorios en hexadeximal
    function getRandomColor() {
        var letters = '0123456789ABCDEF';
        var color = '#';
        for (var i = 0; i < 6; i++) {
          color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }

    // Cargar informaci贸n del usuario autenticado
    $.get('/user', function(data) {
      if (data.isAuthenticated && data.user) {
        currentUser = data.user;
        $('#userName').text(data.user.name || data.user.nickname);
        $('#userEmail').text(data.user.email);
        $('#userAvatar').attr('src', data.user.picture);
        
        // Usar el nombre del usuario de Auth0 en el chat
        $('#nombre').val(data.user.name || data.user.nickname);
      }
    });

    $(function () {
      var socket = io();

      // emite evento al servidor
      $('form').submit(function(){
        var nombreTxt = $('#nombre').val() || "An贸nimo";
        var mensajeTxt = $('#m').val();

        if (!mensajeTxt.trim()) {
          return false;
        }

        if (colorHexTxt == "") {
          colorHexTxt = getRandomColor();
        }

        var jsonMsg = { nombre: nombreTxt, mensaje: mensajeTxt, color: colorHexTxt };
        socket.emit('Evento-Mensaje-Server', JSON.stringify(jsonMsg));
        $('#m').val('');
        return false;
      });

      socket.on('Evento-Mensaje-Server', function(msg){
        var msgJson = JSON.parse(msg);
        var mensajeDisplay = "<b style='color:"+ msgJson.color +"'>" + msgJson.nombre + "</b>: " + msgJson.mensaje;
        $('#messages').append($('<li>').html(mensajeDisplay));
        window.scrollTo(0, document.body.scrollHeight);
      });

      // Notificar cuando se conecta
      socket.on('connect', function() {
        console.log('Connected to chat server');
      });

      socket.on('disconnect', function() {
        console.log('Disconnected from chat server');
      });
    });
    </script>
  </body>
</html>